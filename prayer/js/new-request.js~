$( document ).ready(function() {
    window.god = window.god || {};
    god.init();
    god.getCategories("afterGetCategories");
    
    $("#newRequestForm").submit(function(e) {
	e.preventDefault();

	var formValues = $("#newRequestForm").serializeArray();
	var category = $("#category-options").val();

	for (var i = 0; i < god.categories.length; i++) {
	    if (god.categories[i].category_name == category) {
		categoryId = god.categories[i].category_id;
		break;
	    }
	}

	console.log("Hello");
	console.log(categoryId);

	params = {
	    command: 'createRequest',
	    jsonpCallback: 'afterCreateRequest',
	    requestText: "\"" + formValues[1].value + "\"",
	    requestTitle: "\"" + formValues[0].value + "\"",
	    requestCategoryId: categoryId
	};
	console.log(params);
	god.sendQuery(params);
    })

    window.afterGetCategories = function(response) {

	//Dropdown plugin data
var ddData = [
    {
        text: "Facebook",
        value: 1,
        selected: false,
        description: "Description with Facebook",
        imageSrc: "https://i.imgur.com/XkuTj3B.png"
    },
    {
        text: "Twitter",
        value: 2,
        selected: false,
        description: "Description with Twitter",
        imageSrc: "https://i.imgur.com/8ScLNnk.png"
    },
    {
        text: "LinkedIn",
        value: 3,
        selected: true,
        description: "Description with LinkedIn",
        imageSrc: "https://i.imgur.com/aDNdibj.png"
    },
    {
        text: "Foursquare",
        value: 4,
        selected: false,
        description: "Description with Foursquare",
        imageSrc: "https://i.imgur.com/kFAk2DX.png"
    }
];
	$('#demoBasic').ddslick({
    data: ddData,
    width: 300,
    imagePosition: "left",
    selectText: "Select your favorite social network",
    onSelected: function (data) {
        console.log(data);
    }
});
	console.log('afterGetCategories success');

	var categoryHtml = "<option>Select a category</option>";
	for (var i = 0; i < response.result.length; i++) {
	    categoryHtml += "<option>" + response.result[i].category_name + "</option>";
	}
	$("#category-options").html(categoryHtml);

	god.categories = response.result;
    }

    window.afterCreateRequest = function(response) {
	console.log('createRequest success');
	window.location.href = "profile.html?create=true";
    }

    window.changeCategory = function() {
	console.log("changeCategory");
	var category = $("#category-options").val();
	console.log(category);
	if (category == "Select a category") {
	    $("#prayer-preview").html("<p>Select a category to preview the prayer that others will see.</p>");
	    return;
	}
	var params = {
	    command: 'getPrayer',
	    jsonpCallback: 'afterGetPrayer',
	    category: category
	};
	god.sendQuery(params);
    }

    window.afterGetPrayer = function(response) {
	var prayerText = response.result[0].prayer_text;
	var realName = $("#real-name").html();

	// substitute for name and gender
	$.ajax({
	    url: "https://api.genderize.io?name=" + realName,
	    dataType: "json",
	    success: function(data) {
		prayerText = god.getCustomPrayer(prayerText, data.gender, realName);
		var lines = prayerText.split("\n");
		var prayerTextHtml = "";
		for (var i = 0; i < lines.length; i++) {
		    prayerTextHtml += "<p>" + lines[i] + "</p>";
		}
		$("#prayer-preview").html(prayerTextHtml);	
	    }
	});
    }
});
